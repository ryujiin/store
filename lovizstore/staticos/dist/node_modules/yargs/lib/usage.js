var decamelize=require("decamelize"),wordwrap=require("wordwrap"),wsize=require("window-size");module.exports=function(e){function c(e,t){var n="[default: ";if(e===undefined)return null;if(t)n+=t;else switch(typeof e){case"string":n+=JSON.stringify(e);break;case"function":n+="("+(e.name.length?decamelize(e.name,"-"):"generated-value")+")";break;default:n+=e}return n+"]"}function h(e,t){var n=[],r=p(Object.keys(e));l&&(r=Math.min(r,parseInt(l/2)));var i=p(Object.keys(e).map(function(t){return e[t].desc}));return Object.keys(e).forEach(function(s){var o=e[s].desc,u=e[s].extra,a=null;l&&(o=wordwrap(r+t+1,l)(o).slice(r+t+1)),l&&s.length>r&&(a=wordwrap(2,r)(s.trim()).split("\n"),s="");var f=(new Array(Math.max(r-s.length+t,0))).join(" "),c=(new Array(Math.max(i-o.length+1,0))).join(" ");!l&&c.length>0&&(o+=c);var h="  "+s+f,p=[o,u].filter(Boolean).join("  ");if(l){var v=o.split("\n"),m=v.slice(-1)[0].length+(v.length===1?h.length:0);u.length>l?p=o+"\n"+wordwrap(r+4,l)(u):p=o+(m+u.length>l-2?"\n"+(new Array(l-u.length+1)).join(" ")+u:(new Array(l-u.length-m+1)).join(" ")+u)}if(a){var g=p.split("\n"),y=h+g[0],b=Math.max(a.length,g.length);for(var w=0;w<b;w++){var s=a[w],E=w?g[w]:y;n.push(d(s,E,y.length))}}else n.push(h+p)}),n}function p(e){return Math.max.apply(null,e.map(function(e){return e.length}))}function d(e,t,n){var r="";e=e||"",t=t||(new Array(n)).join(" ");for(var i=0;i<t.length;i++){var s=t.charAt(i);s===" "&&(s=e.charAt(i)||s),r+=s}return r}function v(){return wsize.width?Math.min(80,wsize.width):null}var t={},n=[];t.failFn=function(e){n.push(e)};var r=null,i=!0;t.showHelpOnFail=function(e,n){return typeof e=="string"?(n=e,e=!0):typeof e=="undefined"&&(e=!0),r=n,i=e,t},t.fail=function(t){if(n.length)n.forEach(function(e){e(t)});else{i&&e.showHelp("error"),t&&console.error(t),r&&(t&&console.error(""),console.error(r));if(!e.getExitProcess())throw new Error(t);process.exit(1)}};var s;t.usage=function(e){s=e};var o=[];t.example=function(e,t){o.push([e,t||""])};var u=[];t.command=function(e,t){u.push([e,t||""])},t.getCommands=function(){return u};var a={};t.describe=function(e,n){typeof e=="object"?Object.keys(e).forEach(function(n){t.describe(n,e[n])}):a[e]=n},t.getDescriptions=function(){return a};var f;t.epilog=function(e){f=e};var l=v();t.wrap=function(e){l=e},t.help=function(){var t=e.getDemanded(),n=e.getOptions(),r=Object.keys(Object.keys(a).concat(Object.keys(t)).concat(Object.keys(n.default)).reduce(function(e,t){return t!=="_"&&(e[t]=!0),e},{})),i=r.length?["Options:"]:[];if(u.length){i.unshift("");var p={};u.forEach(function(e){p[e[0]]={desc:e[1],extra:""}}),i=["Commands:"].concat(h(p,5),i)}if(s){var d=s.replace(/\$0/g,e.$0);l&&(d=wordwrap(0,l)(d)),i.unshift(d,"")}var v=(Object.keys(n.alias)||[]).concat(Object.keys(e.parsed.newAliases)||[]);r=r.filter(function(t){return!e.parsed.newAliases[t]&&v.every(function(e){return-1==(n.alias[e]||[]).indexOf(t)})});var m=r.reduce(function(e,t){return e[t]=[t].concat(n.alias[t]||[]).map(function(e){return(e.length>1?"--":"-")+e}).join(", "),e},{}),g={};r.forEach(function(e){var r=m[e],i=a[e]||"",s=null;n.boolean[e]&&(s="[boolean]"),n.count[e]&&(s="[count]"),n.string[e]&&(s="[string]"),n.normalize[e]&&(s="[string]");var o=[s,t[e]?"[required]":null,c(n.default[e],n.defaultDescription[e])].filter(Boolean).join("  ");g[r]={desc:i,extra:o}}),i.push.apply(i,h(g,3)),r.length&&i.push("");if(o.length){o.forEach(function(t){t[0]=t[0].replace(/\$0/g,e.$0)});var y={};o.forEach(function(e){y[e[0]]={desc:e[1],extra:""}}),i.push.apply(i,["Examples:"].concat(h(y,5),""))}if(f){var b=f.replace(/\$0/g,e.$0);l&&(b=wordwrap(0,l)(b)),i.push(b,"")}return i.join("\n")},t.showHelp=function(e){e=e||"error",console[e](t.help())};var m=null;return t.version=function(e,t,n){m=e},t.showVersion=function(){typeof m=="function"?console.log(m()):console.log(m)},t};