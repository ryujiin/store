var camelCase=require("camelcase"),fs=require("fs"),path=require("path");module.exports=function(e,t){function m(e,n,r){var i=x(n,t.narg);if(r.length-(e+1)<i)throw Error("not enough arguments following: "+n);for(var s=e+1;s<i+e+1;s++)g(n,r[s]);return e+i}function g(e,t){(x(e,n.bools)||x(e,n.counts))&&typeof t=="string"&&(t=t==="true");if(/-/.test(e)&&(!r[e]||!r[e].length)){var s=camelCase(e);r[e]=[s],i[s]=!0}var u=!x(e,n.strings)&&C(t)?Number(t):t;x(e,n.counts)&&(u=function(e){return e!==undefined?e+1:0});var a=e.split(".");E(o,a,u),(r[a[0]]||[]).forEach(function(e){e=e.split(".");if(a.length>1){var t=[].concat(a);t.shift(),e=e.concat(t)}E(o,e,u)});var f=[e].concat(r[e]||[]);for(var l=0,c=f.length;l<c;l++)if(n.normalize[f[l]]){f.forEach(function(e){o.__defineSetter__(e,function(e){t=path.normalize(e)}),o.__defineGetter__(e,function(){return typeof t=="string"?path.normalize(t):t})});break}}function y(e){var t={};b(t,r,s),Object.keys(n.configs).forEach(function(n){var r=e[n]||t[n];if(r)try{var i=JSON.parse(fs.readFileSync(r,"utf8"));Object.keys(i).forEach(function(t){e[t]===undefined&&(delete e[t],g(t,i[t]))})}catch(s){throw Error("invalid json config file: "+r)}})}function b(e,t,n){Object.keys(n).forEach(function(r){w(e,r.split("."))||(E(e,r.split("."),n[r]),(t[r]||[]).forEach(function(t){E(e,t.split("."),n[r])}))})}function w(e,t){var n=e;t.slice(0,-1).forEach(function(e){n=n[e]||{}});var r=t[t.length-1];return r in n}function E(e,t,r){var i=e;t.slice(0,-1).forEach(function(e){i[e]===undefined&&(i[e]={}),i=i[e]});var s=t[t.length-1];typeof r=="function"?i[s]=r(i[s]):i[s]===undefined&&x(s,n.arrays)?i[s]=Array.isArray(r)?r:[r]:i[s]===undefined||typeof i[s]=="boolean"?i[s]=r:Array.isArray(i[s])?i[s].push(r):i[s]=[i[s],r]}function S(e){Object.keys(e||{}).forEach(function(e){r[e]=[].concat(t.alias[e]||[]),r[e].concat(e).forEach(function(t){if(/-/.test(t)){var n=camelCase(t);r[e].push(n),i[n]=!0}}),r[e].forEach(function(t){r[t]=[e].concat(r[e].filter(function(e){return t!==e}))})})}function x(e,t){var n=!1,i=[].concat(r[e]||[],e);return i.forEach(function(e){t[e]&&(n=t[e])}),n}function T(e){var t={"boolean":!0,string:"",array:[]};return t[e]}function N(e,t){var n="boolean";return t.strings&&t.strings[e]?n="string":t.arrays&&t.arrays[e]&&(n="array"),n}function C(e){return typeof e=="number"?!0:/^0x[0-9a-f]+$/i.test(e)?!0:/^[-+]?(?:\d+(?:\.\d*)?|\.\d+)(e[-+]?\d+)?$/.test(e)}t||(t={});var n={arrays:{},bools:{},strings:{},counts:{},normalize:{},configs:{}};[].concat(t.array).filter(Boolean).forEach(function(e){n.arrays[e]=!0}),[].concat(t["boolean"]).filter(Boolean).forEach(function(e){n.bools[e]=!0}),[].concat(t.string).filter(Boolean).forEach(function(e){n.strings[e]=!0}),[].concat(t.count).filter(Boolean).forEach(function(e){n.counts[e]=!0}),[].concat(t.normalize).filter(Boolean).forEach(function(e){n.normalize[e]=!0}),[].concat(t.config).filter(Boolean).forEach(function(e){n.configs[e]=!0});var r={},i={};S(t.key),S(t.alias);var s=t["default"]||{};Object.keys(s).forEach(function(e){if(/-/.test(e)&&!t.alias[e]){var n=camelCase(e);r[e]=r[e]||[],r[e].indexOf(n)===-1&&(r[e]=(r[e]||[]).concat(n),i[n]=!0)}(r[e]||[]).forEach(function(t){s[t]=s[e]})});var o={_:[]};Object.keys(n.bools).forEach(function(e){g(e,e in s?s[e]:!1)});var u=[];e.indexOf("--")!==-1&&(u=e.slice(e.indexOf("--")+1),e=e.slice(0,e.indexOf("--")));for(var a=0;a<e.length;a++){var f=e[a];if(f.match(/^--.+=/)){var l=f.match(/^--([^=]+)=([\s\S]*)$/);g(l[1],l[2])}else if(f.match(/^--no-.+/)){var c=f.match(/^--no-(.+)/)[1];g(c,!1)}else if(f.match(/^--.+/)){var c=f.match(/^--(.+)/)[1];if(x(c,t.narg))a=m(a,c,e);else{var h=e[a+1];h!==undefined&&!h.match(/^-/)&&!x(c,n.bools)&&!x(c,n.counts)?(g(c,h),a++):/^(true|false)$/.test(h)?(g(c,h),a++):g(c,T(N(c,n)))}}else if(f.match(/^-.\..+=/)){var l=f.match(/^-([^=]+)=([\s\S]*)$/);g(l[1],l[2])}else if(f.match(/^-.\..+/)){var c=f.match(/^-(.\..+)/)[1],h=e[a+1];h!==undefined&&!h.match(/^-/)&&!x(c,n.bools)&&!x(c,n.counts)?(g(c,h),a++):g(c,T(N(c,n)))}else if(f.match(/^-[^-]+/)){var p=f.slice(1,-1).split(""),d=!1;for(var v=0;v<p.length;v++){var h=f.slice(v+2);if(p[v+1]&&p[v+1]==="="){g(p[v],f.slice(v+3)),d=!0;break}if(h==="-"){g(p[v],h);continue}if(/[A-Za-z]/.test(p[v])&&/-?\d+(\.\d*)?(e-?\d+)?$/.test(h)){g(p[v],h),d=!0;break}if(p[v+1]&&p[v+1].match(/\W/)){g(p[v],f.slice(v+2)),d=!0;break}g(p[v],T(N(p[v],n)))}var c=f.slice(-1)[0];!d&&c!=="-"&&(x(c,t.narg)?a=m(a,c,e):e[a+1]&&!/^(-|--)[^-]/.test(e[a+1])&&!x(c,n.bools)&&!x(c,n.counts)?(g(c,e[a+1]),a++):e[a+1]&&/true|false/.test(e[a+1])?(g(c,e[a+1]),a++):g(c,T(N(c,n))))}else o._.push(n.strings._||!C(f)?f:Number(f))}return y(o),b(o,r,s),Object.keys(n.counts).forEach(function(e){g(e,s[e])}),u.forEach(function(e){o._.push(e)}),{argv:o,aliases:r,newAliases:i}};