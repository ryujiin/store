/*!
 * Makes a string safe for a regular expression.
 * @param  {string} str
 * @return {string}
 * @private
 */

/*!
   * Loop over the source, split via the tag/var/comment regular expression splitter.
   * Send each chunk to the appropriate parser.
   */

function escapeRegExp(e){return e.replace(/[\-\/\\\^$*+?.()|\[\]{}]/g,"\\$&")}function TokenParser(e,t,n,r,i){this.out=[],this.state=[],this.filterApplyIdx=[],this._parsers={},this.line=r,this.filename=i,this.filters=t,this.escape=n,this.parse=function(){var t=this;return t._parsers.start&&t._parsers.start.call(t),utils.each(e,function(n,r){var i=e[r-1];t.isLast=r===e.length-1;if(i)while(i.type===_t.WHITESPACE)r-=1,i=e[r-1];t.prevToken=i,t.parseToken(n)}),t._parsers.end&&t._parsers.end.call(t),t.escape&&(t.filterApplyIdx=[0],typeof t.escape=="string"?(t.parseToken({type:_t.FILTER,match:"e"}),t.parseToken({type:_t.COMMA,match:","}),t.parseToken({type:_t.STRING,match:String(n)}),t.parseToken({type:_t.PARENCLOSE,match:")"})):t.parseToken({type:_t.FILTEREMPTY,match:"e"})),t.out}}var utils=require("./utils"),lexer=require("./lexer"),_t=lexer.types,_reserved=["break","case","catch","continue","debugger","default","delete","do","else","finally","for","function","if","in","instanceof","new","return","switch","this","throw","try","typeof","var","void","while","with"];TokenParser.prototype={on:function(e,t){this._parsers[e]=t},parseToken:function(e){var t=this,n=t._parsers[e.type]||t._parsers["*"],r=e.match,i=t.prevToken,s=i?i.type:null,o=t.state.length?t.state[t.state.length-1]:null,u;if(n&&typeof n=="function"&&!n.call(this,e))return;o&&i&&o===_t.FILTER&&s===_t.FILTER&&e.type!==_t.PARENCLOSE&&e.type!==_t.COMMA&&e.type!==_t.OPERATOR&&e.type!==_t.FILTER&&e.type!==_t.FILTEREMPTY&&t.out.push(", "),o&&o===_t.METHODOPEN&&(t.state.pop(),e.type!==_t.PARENCLOSE&&t.out.push(", "));switch(e.type){case _t.WHITESPACE:break;case _t.STRING:t.filterApplyIdx.push(t.out.length),t.out.push(r.replace(/\\/g,"\\\\"));break;case _t.NUMBER:case _t.BOOL:t.filterApplyIdx.push(t.out.length),t.out.push(r);break;case _t.FILTER:(!t.filters.hasOwnProperty(r)||typeof t.filters[r]!="function")&&utils.throwError('Invalid filter "'+r+'"',t.line,t.filename),t.escape=t.filters[r].safe?!1:t.escape,t.out.splice(t.filterApplyIdx[t.filterApplyIdx.length-1],0,'_filters["'+r+'"]('),t.state.push(e.type);break;case _t.FILTEREMPTY:(!t.filters.hasOwnProperty(r)||typeof t.filters[r]!="function")&&utils.throwError('Invalid filter "'+r+'"',t.line,t.filename),t.escape=t.filters[r].safe?!1:t.escape,t.out.splice(t.filterApplyIdx[t.filterApplyIdx.length-1],0,'_filters["'+r+'"]('),t.out.push(")");break;case _t.FUNCTION:case _t.FUNCTIONEMPTY:t.out.push("((typeof _ctx."+r+' !== "undefined") ? _ctx.'+r+" : ((typeof "+r+' !== "undefined") ? '+r+" : _fn))("),t.escape=!1,e.type===_t.FUNCTIONEMPTY?t.out[t.out.length-1]=t.out[t.out.length-1]+")":t.state.push(e.type),t.filterApplyIdx.push(t.out.length-1);break;case _t.PARENOPEN:t.state.push(e.type),t.filterApplyIdx.length?(t.out.splice(t.filterApplyIdx[t.filterApplyIdx.length-1],0,"("),i&&s===_t.VAR?(u=i.match.split(".").slice(0,-1),t.out.push(" || _fn).call("+t.checkMatch(u)),t.state.push(_t.METHODOPEN),t.escape=!1):t.out.push(" || _fn)("),t.filterApplyIdx.push(t.out.length-3)):(t.out.push("("),t.filterApplyIdx.push(t.out.length-1));break;case _t.PARENCLOSE:u=t.state.pop(),u!==_t.PARENOPEN&&u!==_t.FUNCTION&&u!==_t.FILTER&&utils.throwError("Mismatched nesting state",t.line,t.filename),t.out.push(")"),t.filterApplyIdx.pop(),u!==_t.FILTER&&t.filterApplyIdx.pop();break;case _t.COMMA:o!==_t.FUNCTION&&o!==_t.FILTER&&o!==_t.ARRAYOPEN&&o!==_t.CURLYOPEN&&o!==_t.PARENOPEN&&o!==_t.COLON&&utils.throwError("Unexpected comma",t.line,t.filename),o===_t.COLON&&t.state.pop(),t.out.push(", "),t.filterApplyIdx.pop();break;case _t.LOGIC:case _t.COMPARATOR:(!i||s===_t.COMMA||s===e.type||s===_t.BRACKETOPEN||s===_t.CURLYOPEN||s===_t.PARENOPEN||s===_t.FUNCTION)&&utils.throwError("Unexpected logic",t.line,t.filename),t.out.push(e.match);break;case _t.NOT:t.out.push(e.match);break;case _t.VAR:t.parseVar(e,r,o);break;case _t.BRACKETOPEN:!i||s!==_t.VAR&&s!==_t.BRACKETCLOSE&&s!==_t.PARENCLOSE?(t.state.push(_t.ARRAYOPEN),t.filterApplyIdx.push(t.out.length)):t.state.push(e.type),t.out.push("[");break;case _t.BRACKETCLOSE:u=t.state.pop(),u!==_t.BRACKETOPEN&&u!==_t.ARRAYOPEN&&utils.throwError("Unexpected closing square bracket",t.line,t.filename),t.out.push("]"),t.filterApplyIdx.pop();break;case _t.CURLYOPEN:t.state.push(e.type),t.out.push("{"),t.filterApplyIdx.push(t.out.length-1);break;case _t.COLON:o!==_t.CURLYOPEN&&utils.throwError("Unexpected colon",t.line,t.filename),t.state.push(e.type),t.out.push(":"),t.filterApplyIdx.pop();break;case _t.CURLYCLOSE:o===_t.COLON&&t.state.pop(),t.state.pop()!==_t.CURLYOPEN&&utils.throwError("Unexpected closing curly brace",t.line,t.filename),t.out.push("}"),t.filterApplyIdx.pop();break;case _t.DOTKEY:(!i||s!==_t.VAR&&s!==_t.BRACKETCLOSE&&s!==_t.DOTKEY&&s!==_t.PARENCLOSE&&s!==_t.FUNCTIONEMPTY&&s!==_t.FILTEREMPTY&&s!==_t.CURLYCLOSE)&&utils.throwError('Unexpected key "'+r+'"',t.line,t.filename),t.out.push("."+r);break;case _t.OPERATOR:t.out.push(" "+r+" "),t.filterApplyIdx.pop()}},parseVar:function(e,t,n){var r=this;t=t.split("."),_reserved.indexOf(t[0])!==-1&&utils.throwError('Reserved keyword "'+t[0]+'" attempted to be used as a variable',r.line,r.filename),r.filterApplyIdx.push(r.out.length);if(n===_t.CURLYOPEN){t.length>1&&utils.throwError("Unexpected dot",r.line,r.filename),r.out.push(t[0]);return}r.out.push(r.checkMatch(t))},checkMatch:function(e){function r(n){var r=n+t,i=e,s="";return s="(typeof "+r+' !== "undefined" && '+r+" !== null",utils.each(i,function(e,t){if(t===0)return;s+=" && "+r+"."+e+" !== undefined && "+r+"."+e+" !== null",r+="."+e}),s+=")",s}function i(t){return"("+r(t)+" ? "+t+e.join(".")+' : "")'}var t=e[0],n;return n="("+r("_ctx.")+" ? "+i("_ctx.")+" : "+i("")+")","("+n+" !== null ? "+n+" : "+'"" )'}},exports.parse=function(e,t,n,r,i){function M(e,t){var r=lexer.read(utils.strip(e)),o,u;return o=new TokenParser(r,i,s,t,n.filename),u=o.parse().join(""),o.state.length&&utils.throwError('Unable to parse "'+e+'"',t,n.filename),{compile:function(){return"_output += "+u+";\n"}}}function _(t,o){var u,a,f,l,c,h,p;if(utils.startsWith(t,"end")){p=N[N.length-1];if(p&&p.name===t.split(/\s+/)[0].replace(/^end/,"")&&p.ends){switch(p.name){case"autoescape":s=n.autoescape;break;case"raw":A=!1}N.pop();return}A||utils.throwError('Unexpected end of tag "'+t.replace(/^end/,"")+'"',o,n.filename)}if(A)return;f=t.split(/\s+(.+)?/),l=f.shift(),r.hasOwnProperty(l)||utils.throwError('Unexpected tag "'+t+'"',o,n.filename),u=lexer.read(utils.strip(f.join(" "))),a=new TokenParser(u,i,!1,o,n.filename),c=r[l],c.parse(f[1],o,a,_t,N,n,e)||utils.throwError('Unexpected tag "'+l+'"',o,n.filename),a.parse(),h=a.out;switch(l){case"autoescape":s=h[0]!=="false"?h[0]:!1;break;case"raw":A=!0}return{block:!!r[l].block,compile:c.compile,args:h,content:[],ends:c.ends,name:l}}function D(e){return typeof e=="string"&&(e=e.replace(/\s*$/,"")),e}t=t.replace(/\r\n/g,"\n");var s=n.autoescape,o=n.tagControls[0],u=n.tagControls[1],a=n.varControls[0],f=n.varControls[1],l=escapeRegExp(o),c=escapeRegExp(u),h=escapeRegExp(a),p=escapeRegExp(f),d=new RegExp("^"+l+"-?\\s*-?|-?\\s*-?"+c+"$","g"),v=new RegExp("^"+l+"-"),m=new RegExp("-"+c+"$"),g=new RegExp("^"+h+"-?\\s*-?|-?\\s*-?"+p+"$","g"),y=new RegExp("^"+h+"-"),b=new RegExp("-"+p+"$"),w=n.cmtControls[0],E=n.cmtControls[1],S="[\\s\\S]*?",x=new RegExp("("+l+S+c+"|"+h+S+p+"|"+escapeRegExp(w)+S+escapeRegExp(E)+")"),T=1,N=[],C=null,k=[],L={},A=!1,O;return exports.parseVariable=M,utils.each(t.split(x),function(e){var t,n,r,i,s;if(!e)return;if(!A&&utils.startsWith(e,a)&&utils.endsWith(e,f))r=y.test(e),O=b.test(e),t=M(e.replace(g,""),T);else if(utils.startsWith(e,o)&&utils.endsWith(e,u))r=v.test(e),O=m.test(e),t=_(e.replace(d,""),T),t&&(t.name==="extends"?C=t.args.join("").replace(/^\'|\'$/g,"").replace(/^\"|\"$/g,""):t.block&&!N.length&&(L[t.args.join("")]=t)),A&&!t&&(t=e);else if(A||!utils.startsWith(e,w)&&!utils.endsWith(e,E))t=O?e.replace(/^\s*/,""):e,O=!1;else if(utils.startsWith(e,w)&&utils.endsWith(e,E))return;r&&k.length&&(i=k.pop(),typeof i=="string"?i=D(i):i.content&&i.content.length&&(s=D(i.content.pop()),i.content.push(s)),k.push(i));if(!t)return;N.length?N[N.length-1].content.push(t):k.push(t),t.name&&t.ends&&N.push(t),n=e.match(/\n/g),T+=n?n.length:0}),{name:n.filename,parent:C,tokens:k,blocks:L}},exports.compile=function(e,t,n,r){var i="",s=utils.isArray(e)?e:e.tokens;return utils.each(s,function(e){var s;if(typeof e=="string"){i+='_output += "'+e.replace(/\\/g,"\\\\").replace(/\n|\r/g,"\\n").replace(/"/g,'\\"')+'";\n';return}s=e.compile(exports.compile,e.args?e.args.slice(0):[],e.content?e.content.slice(0):[],t,n,r),i+=s||""}),i};