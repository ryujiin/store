/*
 * Copyright 2011 Mozilla Foundation and contributors
 * Licensed under the New BSD license. See LICENSE or:
 * http://opensource.org/licenses/BSD-3-Clause
 */

define(["require","exports","module","./source-map-generator","./util"],function(e,t,n){function u(e,t,n,r,i){this.children=[],this.sourceContents={},this.line=e===undefined?null:e,this.column=t===undefined?null:t,this.source=n===undefined?null:n,this.name=i===undefined?null:i,r!=null&&this.add(r)}var r=e("./source-map-generator").SourceMapGenerator,i=e("./util"),s=/(\r?\n)/g,o=/\r\n|[\s\S]/g;u.fromStringWithSourceMap=function(t,n){function c(e,t){e===null||e.source===undefined?r.add(t):r.add(new u(e.originalLine,e.originalColumn,e.source,t,e.name))}var r=new u,i=t.split(s),o=function(){var e=i.shift(),t=i.shift()||"";return e+t},a=1,f=0,l=null;return n.eachMapping(function(e){if(l!==null){if(!(a<e.generatedLine)){var n=i[0],t=n.substr(0,e.generatedColumn-f);i[0]=n.substr(e.generatedColumn-f),f=e.generatedColumn,c(l,t),l=e;return}var t="";c(l,o()),a++,f=0}while(a<e.generatedLine)r.add(o()),a++;if(f<e.generatedColumn){var n=i[0];r.add(n.substr(0,e.generatedColumn)),i[0]=n.substr(e.generatedColumn),f=e.generatedColumn}l=e},this),i.length>0&&(l&&c(l,o()),r.add(i.join(""))),n.sources.forEach(function(e){var t=n.sourceContentFor(e);t&&r.setSourceContent(e,t)}),r},u.prototype.add=function(t){if(Array.isArray(t))t.forEach(function(e){this.add(e)},this);else{if(!(t instanceof u||typeof t=="string"))throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+t);t&&this.children.push(t)}return this},u.prototype.prepend=function(t){if(Array.isArray(t))for(var n=t.length-1;n>=0;n--)this.prepend(t[n]);else{if(!(t instanceof u||typeof t=="string"))throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+t);this.children.unshift(t)}return this},u.prototype.walk=function(t){var n;for(var r=0,i=this.children.length;r<i;r++)n=this.children[r],n instanceof u?n.walk(t):n!==""&&t(n,{source:this.source,line:this.line,column:this.column,name:this.name})},u.prototype.join=function(t){var n,r,i=this.children.length;if(i>0){n=[];for(r=0;r<i-1;r++)n.push(this.children[r]),n.push(t);n.push(this.children[r]),this.children=n}return this},u.prototype.replaceRight=function(t,n){var r=this.children[this.children.length-1];return r instanceof u?r.replaceRight(t,n):typeof r=="string"?this.children[this.children.length-1]=r.replace(t,n):this.children.push("".replace(t,n)),this},u.prototype.setSourceContent=function(t,n){this.sourceContents[i.toSetString(t)]=n},u.prototype.walkSourceContents=function(t){for(var n=0,r=this.children.length;n<r;n++)this.children[n]instanceof u&&this.children[n].walkSourceContents(t);var s=Object.keys(this.sourceContents);for(var n=0,r=s.length;n<r;n++)t(i.fromSetString(s[n]),this.sourceContents[s[n]])},u.prototype.toString=function(){var t="";return this.walk(function(e){t+=e}),t},u.prototype.toStringWithSourceMap=function(t){var n={code:"",line:1,column:0},i=new r(t),u=!1,a=null,f=null,l=null,c=null;return this.walk(function(e,t){n.code+=e,t.source!==null&&t.line!==null&&t.column!==null?((a!==t.source||f!==t.line||l!==t.column||c!==t.name)&&i.addMapping({source:t.source,original:{line:t.line,column:t.column},generated:{line:n.line,column:n.column},name:t.name}),a=t.source,f=t.line,l=t.column,c=t.name,u=!0):u&&(i.addMapping({generated:{line:n.line,column:n.column}}),a=null,u=!1),e.match(o).forEach(function(e,r,o){s.test(e)?(n.line++,n.column=0,r+1===o.length?(a=null,u=!1):u&&i.addMapping({source:t.source,original:{line:t.line,column:t.column},generated:{line:n.line,column:n.column},name:t.name})):n.column+=e.length})}),this.walkSourceContents(function(e,t){i.setSourceContent(e,t)}),{code:n.code,map:i}},t.SourceNode=u});