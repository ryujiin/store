/*
 * Copyright 2011 Mozilla Foundation and contributors
 * Licensed under the New BSD license. See LICENSE or:
 * http://opensource.org/licenses/BSD-3-Clause
 */

define(["require","exports","module","../../lib/source-map/source-map-generator","../../lib/source-map/source-map-consumer","../../lib/source-map/source-node"],function(e,t,n){function o(e){return function(t,n){["\n","\r\n"].forEach(e.bind(null,t,n))}}var r=e("../../lib/source-map/source-map-generator").SourceMapGenerator,i=e("../../lib/source-map/source-map-consumer").SourceMapConsumer,s=e("../../lib/source-map/source-node").SourceNode;t["test .add()"]=function(e,t){var n=new s(null,null,null);n.add("function noop() {}"),n.add(new s(null,null,null)),n.add(["function foo() {",new s(null,null,null,"return 10;"),"}"]),e.throws(function(){n.add({})}),e.throws(function(){n.add(function(){})})},t["test .prepend()"]=function(e,t){var n=new s(null,null,null);n.prepend("function noop() {}"),e.equal(n.children[0],"function noop() {}"),e.equal(n.children.length,1),n.prepend(new s(null,null,null)),e.equal(n.children[0],""),e.equal(n.children[1],"function noop() {}"),e.equal(n.children.length,2),n.prepend(["function foo() {",new s(null,null,null,"return 10;"),"}"]),e.equal(n.children[0],"function foo() {"),e.equal(n.children[1],"return 10;"),e.equal(n.children[2],"}"),e.equal(n.children[3],""),e.equal(n.children[4],"function noop() {}"),e.equal(n.children.length,5),e.throws(function(){n.prepend({})}),e.throws(function(){n.prepend(function(){})})},t["test .toString()"]=function(e,t){e.equal((new s(null,null,null,["function foo() {",new s(null,null,null,"return 10;"),"}"])).toString(),"function foo() {return 10;}")},t["test .join()"]=function(e,t){e.equal((new s(null,null,null,["a","b","c","d"])).join(", ").toString(),"a, b, c, d")},t["test .walk()"]=function(e,t){var n=new s(null,null,null,["(function () {\n","  ",new s(1,0,"a.js",["someCall()"]),";\n","  ",new s(2,0,"b.js",["if (foo) bar()"]),";\n","}());"]),r=[{str:"(function () {\n",source:null,line:null,column:null},{str:"  ",source:null,line:null,column:null},{str:"someCall()",source:"a.js",line:1,column:0},{str:";\n",source:null,line:null,column:null},{str:"  ",source:null,line:null,column:null},{str:"if (foo) bar()",source:"b.js",line:2,column:0},{str:";\n",source:null,line:null,column:null},{str:"}());",source:null,line:null,column:null}],i=0;n.walk(function(t,n){e.equal(r[i].str,t),e.equal(r[i].source,n.source),e.equal(r[i].line,n.line),e.equal(r[i].column,n.column),i++})},t["test .replaceRight"]=function(e,t){var n;n=new s(null,null,null,"hello world"),n.replaceRight(/world/,"universe"),e.equal(n.toString(),"hello universe"),n=new s(null,null,null,[new s(null,null,null,"hey sexy mama, "),new s(null,null,null,"want to kill all humans?")]),n.replaceRight(/kill all humans/,"watch Futurama"),e.equal(n.toString(),"hey sexy mama, want to watch Futurama?")},t["test .toStringWithSourceMap()"]=o(function(e,t,n){var o=new s(null,null,null,["(function () {"+n,"  ",new s(1,0,"a.js","someCall","originalCall"),new s(1,8,"a.js","()"),";"+n,"  ",new s(2,0,"b.js",["if (foo) bar()"]),";"+n,"}());"]),u=o.toStringWithSourceMap({file:"foo.js"});e.equal(u.code,["(function () {","  someCall();","  if (foo) bar();","}());"].join(n));var a=u.map,f=o.toStringWithSourceMap().map;e.ok(a instanceof r,"map instanceof SourceMapGenerator"),e.ok(f instanceof r,"mapWithoutOptions instanceof SourceMapGenerator"),f._file="foo.js",t.assertEqualMaps(e,a.toJSON(),f.toJSON()),a=new i(a.toString());var l;l=a.originalPositionFor({line:1,column:4}),e.equal(l.source,null),e.equal(l.line,null),e.equal(l.column,null),l=a.originalPositionFor({line:2,column:2}),e.equal(l.source,"a.js"),e.equal(l.line,1),e.equal(l.column,0),e.equal(l.name,"originalCall"),l=a.originalPositionFor({line:3,column:2}),e.equal(l.source,"b.js"),e.equal(l.line,2),e.equal(l.column,0),l=a.originalPositionFor({line:3,column:16}),e.equal(l.source,null),e.equal(l.line,null),e.equal(l.column,null),l=a.originalPositionFor({line:4,column:2}),e.equal(l.source,null),e.equal(l.line,null),e.equal(l.column,null)}),t["test .fromStringWithSourceMap()"]=o(function(e,t,n){var o=t.testGeneratedCode.replace(/\n/g,n),u=s.fromStringWithSourceMap(o,new i(t.testMap)),a=u.toStringWithSourceMap({file:"min.js"}),f=a.map,l=a.code;e.equal(l,o),e.ok(f instanceof r,"map instanceof SourceMapGenerator"),f=f.toJSON(),e.equal(f.version,t.testMap.version),e.equal(f.file,t.testMap.file),e.equal(f.mappings,t.testMap.mappings)}),t["test .fromStringWithSourceMap() empty map"]=o(function(e,t,n){var o=s.fromStringWithSourceMap(t.testGeneratedCode.replace(/\n/g,n),new i(t.emptyMap)),u=o.toStringWithSourceMap({file:"min.js"}),a=u.map,f=u.code;e.equal(f,t.testGeneratedCode.replace(/\n/g,n)),e.ok(a instanceof r,"map instanceof SourceMapGenerator"),a=a.toJSON(),e.equal(a.version,t.emptyMap.version),e.equal(a.file,t.emptyMap.file),e.equal(a.mappings.length,t.emptyMap.mappings.length),e.equal(a.mappings,t.emptyMap.mappings)}),t["test .fromStringWithSourceMap() complex version"]=o(function(e,t,n){var o=new s(null,null,null,["(function() {"+n,"  var Test = {};"+n,"  ",new s(1,0,"a.js","Test.A = { value: 1234 };"+n),"  ",new s(2,0,"a.js","Test.A.x = 'xyz';"),n,"}());"+n,"/* Generated Source */"]);o=o.toStringWithSourceMap({file:"foo.js"});var u=s.fromStringWithSourceMap(o.code,new i(o.map.toString())),a=u.toStringWithSourceMap({file:"foo.js"}),f=a.map,l=a.code;e.equal(l,o.code),e.ok(f instanceof r,"map instanceof SourceMapGenerator"),f=f.toJSON();var c=o.map.toJSON();t.assertEqualMaps(e,f,c)}),t["test .toStringWithSourceMap() merging duplicate mappings"]=o(function(e,t,n){var i=new s(null,null,null,[new s(1,0,"a.js","(function"),new s(1,0,"a.js","() {"+n),"  ",new s(1,0,"a.js","var Test = "),new s(1,0,"b.js","{};"+n),new s(2,0,"b.js","Test"),new s(2,0,"b.js",".A","A"),new s(2,20,"b.js"," = { value: ","A"),"1234",new s(2,40,"b.js"," };"+n,"A"),"}());"+n,"/* Generated Source */"]);i=i.toStringWithSourceMap({file:"foo.js"}),e.equal(i.code,["(function() {","  var Test = {};","Test.A = { value: 1234 };","}());","/* Generated Source */"].join(n));var o=new r({file:"foo.js"});o.addMapping({generated:{line:1,column:0},source:"a.js",original:{line:1,column:0}}),o.addMapping({generated:{line:2,column:2},source:"a.js",original:{line:1,column:0}}),o.addMapping({generated:{line:2,column:13},source:"b.js",original:{line:1,column:0}}),o.addMapping({generated:{line:3,column:0},source:"b.js",original:{line:2,column:0}}),o.addMapping({generated:{line:3,column:4},source:"b.js",name:"A",original:{line:2,column:0}}),o.addMapping({generated:{line:3,column:6},source:"b.js",name:"A",original:{line:2,column:20}}),o.addMapping({generated:{line:3,column:18}}),o.addMapping({generated:{line:3,column:22},source:"b.js",name:"A",original:{line:2,column:40}});var u=i.map.toJSON();o=o.toJSON(),t.assertEqualMaps(e,u,o)}),t["test .toStringWithSourceMap() multi-line SourceNodes"]=o(function(e,t,n){var i=new s(null,null,null,[new s(1,0,"a.js","(function() {"+n+"var nextLine = 1;"+n+"anotherLine();"+n),new s(2,2,"b.js","Test.call(this, 123);"+n),new s(2,2,"b.js","this['stuff'] = 'v';"+n),new s(2,2,"b.js","anotherLine();"+n),"/*"+n+"Generated"+n+"Source"+n+"*/"+n,new s(3,4,"c.js","anotherLine();"+n),"/*"+n+"Generated"+n+"Source"+n+"*/"]);i=i.toStringWithSourceMap({file:"foo.js"}),e.equal(i.code,["(function() {","var nextLine = 1;","anotherLine();","Test.call(this, 123);","this['stuff'] = 'v';","anotherLine();","/*","Generated","Source","*/","anotherLine();","/*","Generated","Source","*/"].join(n));var o=new r({file:"foo.js"});o.addMapping({generated:{line:1,column:0},source:"a.js",original:{line:1,column:0}}),o.addMapping({generated:{line:2,column:0},source:"a.js",original:{line:1,column:0}}),o.addMapping({generated:{line:3,column:0},source:"a.js",original:{line:1,column:0}}),o.addMapping({generated:{line:4,column:0},source:"b.js",original:{line:2,column:2}}),o.addMapping({generated:{line:5,column:0},source:"b.js",original:{line:2,column:2}}),o.addMapping({generated:{line:6,column:0},source:"b.js",original:{line:2,column:2}}),o.addMapping({generated:{line:11,column:0},source:"c.js",original:{line:3,column:4}});var u=i.map.toJSON();o=o.toJSON(),t.assertEqualMaps(e,u,o)}),t["test .toStringWithSourceMap() with empty string"]=function(e,t){var n=new s(1,0,"empty.js",""),r=n.toStringWithSourceMap();e.equal(r.code,"")},t["test setSourceContent with toStringWithSourceMap"]=function(e,t){var n=new s(1,1,"a.js","a");n.setSourceContent("a.js","someContent");var o=new s(null,null,null,["(function () {\n","  ",n,"  ",new s(1,1,"b.js","b"),"}());"]);o.setSourceContent("b.js","otherContent");var u=o.toStringWithSourceMap({file:"foo.js"}).map;e.ok(u instanceof r,"map instanceof SourceMapGenerator"),u=new i(u.toString()),e.equal(u.sources.length,2),e.equal(u.sources[0],"a.js"),e.equal(u.sources[1],"b.js"),e.equal(u.sourcesContent.length,2),e.equal(u.sourcesContent[0],"someContent"),e.equal(u.sourcesContent[1],"otherContent")},t["test walkSourceContents"]=function(e,t){var n=new s(1,1,"a.js","a");n.setSourceContent("a.js","someContent");var r=new s(null,null,null,["(function () {\n","  ",n,"  ",new s(1,1,"b.js","b"),"}());"]);r.setSourceContent("b.js","otherContent");var i=[];r.walkSourceContents(function(e,t){i.push([e,t])}),e.equal(i.length,2),e.equal(i[0][0],"a.js"),e.equal(i[0][1],"someContent"),e.equal(i[1][0],"b.js"),e.equal(i[1][1],"otherContent")}});