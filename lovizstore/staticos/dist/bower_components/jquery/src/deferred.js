define(["./core","./var/slice","./callbacks"],function(e,t){function n(e){return e}function r(e){throw e}function i(t,n,r){var i;try{t&&e.isFunction(i=t.promise)?i.call(t).done(n).fail(r):t&&e.isFunction(i=t.then)?i.call(t,n,r):n.call(undefined,t)}catch(t){r.call(undefined,t)}}return e.extend({Deferred:function(t){var i=[["notify","progress",e.Callbacks("memory"),e.Callbacks("memory"),2],["resolve","done",e.Callbacks("once memory"),e.Callbacks("once memory"),0,"resolved"],["reject","fail",e.Callbacks("once memory"),e.Callbacks("once memory"),1,"rejected"]],s="pending",o={state:function(){return s},always:function(){return u.done(arguments).fail(arguments),this},"catch":function(e){return o.then(null,e)},pipe:function(){var t=arguments;return e.Deferred(function(n){e.each(i,function(r,i){var s=e.isFunction(t[i[4]])&&t[i[4]];u[i[1]](function(){var t=s&&s.apply(this,arguments);t&&e.isFunction(t.promise)?t.promise().progress(n.notify).done(n.resolve).fail(n.reject):n[i[0]+"With"](this,s?[t]:arguments)})}),t=null}).promise()},then:function(t,s,o){function a(t,i,s,o){return function(){var f=this,l=arguments,c=function(){var c,h;if(t<u)return;c=s.apply(f,l);if(c===i.promise())throw new TypeError("Thenable self-resolution");h=c&&(typeof c=="object"||typeof c=="function")&&c.then,e.isFunction(h)?o?h.call(c,a(u,i,n,o),a(u,i,r,o)):(u++,h.call(c,a(u,i,n,o),a(u,i,r,o),a(u,i,n,i.notifyWith))):(s!==n&&(f=undefined,l=[c]),(o||i.resolveWith)(f,l))},h=o?c:function(){try{c()}catch(n){e.Deferred.exceptionHook&&e.Deferred.exceptionHook(n,h.stackTrace),t+1>=u&&(s!==r&&(f=undefined,l=[n]),i.rejectWith(f,l))}};t?h():(e.Deferred.getStackHook&&(h.stackTrace=e.Deferred.getStackHook()),window.setTimeout(h))}}var u=0;return e.Deferred(function(u){i[0][3].add(a(0,u,e.isFunction(o)?o:n,u.notifyWith)),i[1][3].add(a(0,u,e.isFunction(t)?t:n)),i[2][3].add(a(0,u,e.isFunction(s)?s:r))}).promise()},promise:function(t){return t!=null?e.extend(t,o):o}},u={};return e.each(i,function(e,t){var n=t[2],r=t[5];o[t[1]]=n.add,r&&n.add(function(){s=r},i[3-e][2].disable,i[0][2].lock),n.add(t[3].fire),u[t[0]]=function(){return u[t[0]+"With"](this===u?undefined:this,arguments),this},u[t[0]+"With"]=n.fireWith}),o.promise(u),t&&t.call(u,u),u},when:function(n){var r=arguments.length,s=r,o=Array(s),u=t.call(arguments),a=e.Deferred(),f=function(e){return function(n){o[e]=this,u[e]=arguments.length>1?t.call(arguments):n,--r||a.resolveWith(o,u)}};if(r<=1){i(n,a.done(f(s)).resolve,a.reject);if(a.state()==="pending"||e.isFunction(u[s]&&u[s].then))return a.then()}while(s--)i(u[s],f(s),a.reject);return a.promise()}}),e});