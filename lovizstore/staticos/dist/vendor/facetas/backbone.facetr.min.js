// backbone.facetr 0.4.0 
// Copyright (c)2012 Arillo GmbH 
// Author: Francesco Macri 
// Distributed under MIT license 
// https://github.com/arillo/Backbone.Facetr 

!function(e,t){if("object"==typeof exports){var n=require("underscore"),r=require("backbone");module.exports=t(n,r)}else"function"==typeof define&&define.amd?define(["underscore","backbone"],t):e.Facetr=t(_,Backbone)}(this,function(e,t,n){t.Facetr=function(e,n){return e instanceof t.Collection?s(e,n):i(e)},t.Facetr.VERSION="0.4.0";var r={},i=function(e){var t=r[e];return t?t:n},s=function(e,t){var n=e.facetrid||t||"fctr"+(new Date).getTime()+Math.floor(99*Math.random()+1),s=i(n);return s?s:(e.facetrid=n,r[n]=new a(e),r[n])},o=function(e,r){var i,s=r.split("."),o=s.length,u=0;for(i=e.get(s[u]),u=1;o>u;u+=1){if(i===n)return i;if(i instanceof Array)return i;i=i instanceof t.Model?i.get(s[u]):"[object Object]"===Object.prototype.toString.call(i)?i[s[u]]:i}return i},u=function(r,i,s,u){e.extend(this,t.Events);var a=this,f=r,l=r,h="value",p="asc",d=[],v=[],m=[],y={},w=u,E="or",S=!1,x={},T=!1,N=[],C=[],k={},L={},A=function(r,i,s){var o=i!==n&&null!==i?i:"undefined",u=!1;if(null!=typeof o&&"object"==typeof o){var a=f.split(".")[1];o=a&&(o instanceof t.Model&&o.get(a)||o[a])||"undefined",u=!0}var l=e.find(r,function(e){return e.value===o});if(l)l.count=l.count+1,l.activeCount=l.activeCount+1;else{var h=e.sortedIndex(e.pluck(d,"value"),o);d.splice(h,0,{value:o,count:1,activeCount:1,active:!1}),y[o]=[]}return u&&y[o].push(s),o},O=function(t){var n,r=o(t,f);if(r instanceof Array)0===r.length?(n=A(d,"undefined",t.cid),y[n].push(t.cid)):e.each(r,function(e){n=A(d,e,t.cid),y[n]&&y[n].push(t.cid)});else{if(null!=r&&"object"==typeof r)throw a.remove(),new Error("Model property can only be a value (string,number,boolean) or Array of values, not an object");n=A(d,r),y[n].push(t.cid)}},M=function(t){e(t).each(function(e){O(e)})},_=function(e,t){return"value"===h?"asc"===p?(e.value>t.value)-(e.value<t.value):(e.value<t.value)-(e.value>t.value):"activeCount"===h?"asc"===p?e.activeCount<t.activeCount?-1:e.activeCount>t.activeCount?1:(e.value>t.value)-(e.value<t.value):e.activeCount<t.activeCount?1:e.activeCount>t.activeCount?-1:(e.value<t.value)-(e.value>t.value):"asc"===p?e.count<t.count?-1:e.count>t.count?1:(e.value>t.value)-(e.value<t.value):e.count<t.count?1:e.count>t.count?-1:(e.value<t.value)-(e.value>t.value)},D=function(){d.sort(_),T&&C.sort(_)},P=function(){return 0!==v.length},H=function(t){for(var n=0,r=d.length;r>n;n+=1){var i=e.intersection(y[d[n].value],t).length;0!==i?d[n].activeCount=i:d[n].activeCount=0}},B=function(e){var t=v.splice(0,v.length);d.splice(0,d.length),m.splice(0,m.length),y={},M(e);for(var n=0,r=t.length;r>n;n+=1)a.value(t[n])},j=function(e){O(e);for(var t=0,n=v.length;n>t;t+=1)a.value(v[t])},F=function(t){var n,r,i=t.cid,s=function(t){for(n=d.length-1;-1!==n;){var r=d[n];if(r.value===t){if(r.count-=1,r.activeCount-=1,0===r.count){d.splice(n,1);var i=e.indexOf(v,r.value);-1!==i&&(v.splice(i,1),S=P())}break}n-=1}};for(var u in y)y.hasOwnProperty(u)&&(n=e.indexOf(y[u],i),-1!==n&&y[u].splice(n,1));if(r=o(t,f))if(r instanceof Array)for(var a=0,l=r.length;l>a;a++)s(r[a]);else s(r);n=e.indexOf(m,i),-1!==n&&m.splice(n,1)},I=function(e){var n,r;o(new t.Model(e.changedAttributes()),f)&&(n=new t.Model(e.previousAttributes()),r=o(n,f),n.cid=e.cid,F(n),j(e))},q=function(t){var n,r;null==k[t.value]&&(k[t.value]=[]),n=[],r=function(i){i.value!==t.value&&n.push(i.value),i.groups&&e.each(i.groups,r)},r(t),k[t.value]=e.union(k[t.value],n)},R=function(t){var r=function(t,n,i){null==L[i.value]&&(L[i.value]=[]),n&&(t.push(n.value),L[i.value]=e.union(L[i.value],t)),i.groups&&e.each(i.groups,function(e){return r(t,i,e)})};r([],n,t)},U=function(t){var n,r,i,s,o;if(s=t.groups,i={value:t.value,label:t.label,active:!1,activeCount:0,count:0},o=e.find(d,function(e){return e.value===i.value}),o&&e.extend(i,o),s&&"[object Array]"===Object.prototype.toString.call(s)&&(r=s.length)>0){for(i.groups=[],n=0;r>n;n+=1)i.groups.push(U(s[n]));i.activeCount=e.reduce(i.groups,function(e,t){return e+t.activeCount},i.activeCount),i.count=e.reduce(i.groups,function(e,t){return e+t.count},i.count)}return q(i),i},z=function(){var e,t;for(C.length=0,e=0,t=N.length;t>e;e+=1)C.push(U(N[e])),R(N[e]);C.sort(_)},W=function(){this.and=function(e,t){return E="and",a.value(e,t),this},this.or=function(e,t){return E="or",a.value(e,t),this}};this.label=function(e){return l=e,this},this.asc=function(){return p="asc",D(),this},this.desc=function(){return p="desc",D(),this},this.sortByValue=function(){return h="value",D(),this},this.sortByCount=function(){return h="count",D(),this},this.sortByActiveCount=function(){return h="activeCount",D(),this},this.toJSON=function(){var e;return e={data:{name:f,hierarchical:T,label:l,extOperator:w,intOperator:E,sort:{by:h,direction:p},selected:S,customData:x},values:d},T&&(e.groupedValues=C),e},this.remove=function(e){s.off("resetCollection",H),s.off("resetOrigCollection",B),s.off("addModel",j),s.off("removeModel",F),s.off("changeModel",I),s.trigger("removeFacet",f,e)},this.value=function(t,n,r){var i,o,u,a,l,c;if(n&&(E=n),a=e.chain(d).pluck("value").indexOf(t).value(),-1!==a){if(l=d[a],l.active||(l.active=!0,v.push(l.value)),u="or"===E||0===m.length?e.union:e.intersection,m=u(m,y[t]),T&&null!=k[l.value]&&(c=k[l.value]).length>0)for(v.concat(c),i=0,o=c.length;o>i;i+=1)m=u(m,y[c[i]])}else-1===v.indexOf(t)&&(v.push(t),"and"===E&&(m=[]));return S=P(),s.trigger("value",f,t,m,r),r||this.trigger("value",t),new W(this,E)},this.removeValue=function(t,n){var r,i,o,u=e.chain(d).pluck("value").indexOf(t).value();if(-1!==u&&(r=d[u],r.active=!1),v.splice(e.indexOf(v,r&&r.value||t),1),o=e.filter(y[t],function(t){for(var n in y)if(y.hasOwnProperty(n)&&-1!==e.indexOf(v,n)&&-1!==e.indexOf(y[n],t))return!1;return!0}),m=e.difference(m,o),"and"===E){i=[];for(var a=0,l=v.length;l>a;a+=1)i=0===i.length?e.union(i,y[v[a]]):e.intersection(i,y[v[a]]);m=e.union(m,i)}if(T&&null!=L[t]){var c=e.intersection(L[t],v);c.length>0&&(m=e.union(m,y[t]))}return S=P(),s.trigger("removeValue",f,t,m,n),n||this.trigger("removeValue",t),this},this.clear=function(e){for(;v.length>0;)this.removeValue(v[0],!0);return e||this.trigger("clear"),this},this.customData=function(e,t){return t!==n?(x[e]=t,this):x[e]},this.isSelected=function(){return S},this.hierarchy=function(e){if("[object Array]"!==Object.prototype.toString.call(e))throw new Error("Facet.hierarchy: wrong settings object. Check the documentation for the right format");return N=e,T=!0,z(),s.on("resetCollection addModel removeModel changeModel",z),this.trigger("hierarchy",N),this},M(i),s.on("resetCollection",H),s.on("resetCollection",D),s.on("resetOrigCollection",B),s.on("addModel",j),s.on("removeModel",F),s.on("changeModel",I)},a=function(n){e.extend(this,t.Events);var i,s,a=this,f={},l={},c={},p=e.extend({},t.Events),v={},m="asc",y=!1,w=function(){for(var e in l)l.hasOwnProperty(e)&&delete l[e];n.each(function(e){var t=e.clone();t.cid=e.cid,l[e.cid]=t})},E=function(e,t){delete f[e],delete c[e],C(),t!==!0&&a.trigger("removeFacet",e)},S=function(e,t){var n=f[e];if(n&&n.operator===t)return n;var r=new u(e,l,p,t);return c[e]=[],{facet:r,operator:t}},x=function(e,t){c[e]=t,C()},T=function(e,t,n,r){x(e,n),r!==!0&&a.trigger("filter",e,t)},N=function(e,t,n,r){x(e,n),r!==!0&&a.trigger("unfilter",e,t)},C=function(){var t,r,i,s,o=[],u=[];for(t in l)l.hasOwnProperty(t)&&o.push(t);for(r in c)c.hasOwnProperty(r)&&f[r].facet.toJSON().data.selected&&(o="or"===f[r].operator?e.union(o,c[r]):e.intersection(o,c[r]));s=function(e){return a(l[e])};for(i in v)if(v.hasOwnProperty(i)){var a=v[i];a instanceof Function&&(o=e.filter(o,s))}o.sort();for(var h=0,d=o.length;d>h;h+=1)u.push(l[o[h]]);p.trigger("resetCollection",o),y=!0,n.reset(u),y=!1},k=function(){y||(w(),p.trigger("resetOrigCollection",l))},L=function(e){var t=e.clone();t.cid=e.cid,l[e.cid]=t,p.trigger("addModel",e)},A=function(t){delete l[t.cid],p.trigger("removeModel",t);var n=e.any(f,function(e){return e.facet.toJSON().data.selected});n||C()},O=function(t){delete l[t.cid];var n=t.clone();n.cid=t.cid,l[t.cid]=n,p.trigger("changeModel",t);var r=e.any(f,function(e){return e.facet.toJSON().data.selected});r||C()},M=function(e){n.comparator=function(e,t){var n,r,s=o(e,i),u=o(t,i);if(isNaN(s)||isNaN(u)?(n=Date.parse(s),r=Date.parse(u),(isNaN(n)||isNaN(r))&&(n=s,r=u)):(n=parseFloat(s,10),r=parseFloat(u,10)),"asc"===m){if(n&&r)return(n>r)-(r>n);if(n)return 1;if(r)return-1}else{if(n&&r)return(r>n)-(n>r);if(n)return-1;if(r)return 1}},n.sort(),e!==!0&&a.trigger("sort",i,m)};this.facet=function(e,t,n){var r=!t||"and"!==t&&"or"!==t?"and":t;return f[e]=S(e,r),n!==!0&&this.trigger("facet",e),f[e].facet},this.toJSON=function(){var t,n,r,i,o=[],u=[];for(t in f)f.hasOwnProperty(t)&&(n=f[t],r=n.facet.toJSON(),r.data.operator=n.operator,s&&s instanceof Array?(i=e.indexOf(s,r.data.name),-1!==i?u[i]=r:o.push(r)):o.push(r));return u.concat(o)},this.clear=function(e){var t;for(t in f)f.hasOwnProperty(t)&&(f[t].facet.remove(),delete f[t]);var r=[];for(t in l)l.hasOwnProperty(t)&&r.push(l[t]);return n.reset(r),c={},e!==!0&&this.trigger("clear"),this},this.clearValues=function(e){var t;for(t in f)f.hasOwnProperty(t)&&f[t].facet.clear();var r=[];for(t in l)l.hasOwnProperty(t)&&r.push(l[t]);return n.reset(r),c={},e!==!0&&this.trigger("clearValues"),this},this.remove=function(){var e=n.facetrid;this.clear(!0),n.off("reset",k),n.off("add",L),n.off("remove",A),n.off("change",O),delete n.facetrid,delete r[e]},this.facetsOrder=function(e,t){return s=e,t!==!0&&this.trigger("facetsOrderChange",e),this},this.sortBy=function(e,t){return i=e,M(t),this},this.asc=function(e){return m="asc",M(e),this},this.desc=function(e){return m="desc",M(e),this},this.addFilter=function(e,t,n){return t&&e&&(v[e]=t,C(n)),this},this.removeFilter=function(e,t){return e&&(delete v[e],C(t)),this},this.clearFilters=function(e){for(var t in v)v.hasOwnProperty(t)&&delete v[t];return C(e),this},this.collection=function(){return n},this.origLength=function(){return e.size(l)},this.facets=function(){return e.pluck(f,"facet")},this.initFromSettingsJSON=function(e){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,w,E;for(i=t.Facetr,r=i(n),s=e.facets,o=e.sort,u=e.search,m=0,w=s.length;w>m;m+=1){switch(a=s[m],f=a.attr,l=a.eop,c=a.iop,h=a.sort,p=a.cust,d=a.vals,v=r.facet(f,l),h.by){case"count":v.sortByCount();break;case"activeCount":v.sortByActiveCount();break;default:v.sortByValue()}if(v[h.direction](),p)for(y in p)p.hasOwnProperty(y)&&v.customData(y,p[y]);for(g=0,E=d.length;E>g;g+=1)v.value(d[g],c)}if(o){var S=o.by,x=o.dir;S&&i(n).sortBy(S),x&&i(n)[x]()}return this.trigger("initFromSettingsJSON"),this},this.settingsJSON=function(){var t,n,r,s,o;if(t={},i&&m&&(t.sort={by:i,dir:m}),0!==e.size(f)){t.facets=[];for(n in f)if(f.hasOwnProperty(n)){r=f[n].facet.toJSON(),s=e.pluck(r.values,"active"),o=[];for(var u=0,a=s.length;a>u;u+=1)s[u]&&o.push(r.values[u].value);t.facets.push({attr:r.data.name,eop:r.data.extOperator,iop:r.data.intOperator,sort:r.data.sort,cust:r.data.customData,vals:o})}}return t},w(),p.on("removeFacet",E,this),p.on("value",T,this),p.on("removeValue clear",N,this),n.on("reset",k),n.on("add",L),n.on("remove",A),n.on("change",O)};return t.Facetr});